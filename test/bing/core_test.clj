(ns bing.core-test
  (:use midje.sweet)
  (:require [bing.core :refer :all]))

(def request-result {:request-time 339, :repeatable? false, :protocol-version {:name "HTTP", :major 1, :minor 1}, :streaming? true, :chunked? false, :reason-phrase "OK", :headers {"Access-Control-Max-Age" "60", "Access-Control-Allow-Headers" "Content-Type, Depth, User-Agent, X-File-Size, X-Requested-With, If-Modified-Since, X-File-Name, Cache-Control", "Server" "TornadoServer/4.5.2", "Content-Type" "application/json; charset=UTF-8", "Access-Control-Allow-Origin" "*", "Connection" "Close", "Access-Control-Allow-Methods" "GET,POST,OPTIONS", "Date" "Sat, 04 Nov 2017 15:45:16 GMT", "Access-Control-Allow-Credentials" "false", "Cache-Control" "max-age=604800, public"}, :orig-content-encoding nil, :status 200, :length -1, :body "[\n  {\n    \"_id\": \"1017\",\n    \"_score\": 79.10487,\n    \"ensembl\": {\n      \"gene\": \"ENSG00000123374\",\n      \"protein\": [\n        \"ENSP00000243067\",\n        \"ENSP00000266970\",\n        \"ENSP00000393605\",\n        \"ENSP00000450983\",\n        \"ENSP00000452138\",\n        \"ENSP00000452514\"\n      ],\n      \"transcript\": [\n        \"ENST00000266970\",\n        \"ENST00000354056\",\n        \"ENST00000440311\",\n        \"ENST00000553376\",\n        \"ENST00000554545\",\n        \"ENST00000554619\",\n        \"ENST00000555357\",\n        \"ENST00000555408\",\n        \"ENST00000556146\",\n        \"ENST00000556276\",\n        \"ENST00000556464\",\n        \"ENST00000556656\"\n      ],\n      \"translation\": [\n        {\n          \"protein\": \"ENSP00000266970\",\n          \"rna\": \"ENST00000266970\"\n        },\n        {\n          \"protein\": \"ENSP00000450983\",\n          \"rna\": \"ENST00000555408\"\n        },\n        {\n          \"protein\": \"ENSP00000452514\",\n          \"rna\": \"ENST00000553376\"\n        },\n        {\n          \"protein\": \"ENSP00000393605\",\n          \"rna\": \"ENST00000440311\"\n        },\n        {\n          \"protein\": \"ENSP00000452138\",\n          \"rna\": \"ENST00000555357\"\n        },\n        {\n          \"protein\": \"ENSP00000243067\",\n          \"rna\": \"ENST00000354056\"\n        }\n      ]\n    },\n    \"entrezgene\": 1017,\n    \"name\": \"cyclin dependent kinase 2\",\n    \"symbol\": \"CDK2\",\n    \"query\": \"CDK2\"\n  },\n  {\n    \"_id\": \"143384\",\n    \"_score\": 4.4531994,\n    \"ensembl\": {\n      \"gene\": \"ENSG00000151893\",\n      \"protein\": [\n        \"ENSP00000358147\",\n        \"ENSP00000431329\"\n      ],\n      \"transcript\": [\n        \"ENST00000369151\",\n        \"ENST00000477583\",\n        \"ENST00000481360\",\n        \"ENST00000489169\",\n        \"ENST00000490610\",\n        \"ENST00000493518\",\n        \"ENST00000544392\"\n      ],\n      \"translation\": [\n        {\n          \"protein\": \"ENSP00000358147\",\n          \"rna\": \"ENST00000369151\"\n        },\n        {\n          \"protein\": \"ENSP00000431329\",\n          \"rna\": \"ENST00000493518\"\n        }\n      ]\n    },\n    \"entrezgene\": 143384,\n    \"name\": \"CDK2 associated cullin domain 1\",\n    \"symbol\": \"CACUL1\",\n    \"query\": \"CDK2\"\n  },\n  {\n    \"_id\": \"1018\",\n    \"_score\": 87.98147,\n    \"ensembl\": {\n      \"gene\": \"ENSG00000250506\",\n      \"protein\": [\n        \"ENSP00000400088\",\n        \"ENSP00000410561\",\n        \"ENSP00000465062\",\n        \"ENSP00000466237\"\n      ],\n      \"transcript\": [\n        \"ENST00000425876\",\n        \"ENST00000448471\",\n        \"ENST00000586261\",\n        \"ENST00000588812\"\n      ],\n      \"translation\": [\n        {\n          \"protein\": \"ENSP00000466237\",\n          \"rna\": \"ENST00000588812\"\n        },\n        {\n          \"protein\": \"ENSP00000410561\",\n          \"rna\": \"ENST00000425876\"\n        },\n        {\n          \"protein\": \"ENSP00000465062\",\n          \"rna\": \"ENST00000586261\"\n        },\n        {\n          \"protein\": \"ENSP00000400088\",\n          \"rna\": \"ENST00000448471\"\n        }\n      ]\n    },\n    \"entrezgene\": 1018,\n    \"name\": \"cyclin dependent kinase 3\",\n    \"symbol\": \"CDK3\",\n    \"query\": \"CDK3\"\n  },\n  {\n    \"_id\": \"100529145\",\n    \"_score\": 6.988237,\n    \"entrezgene\": 100529145,\n    \"name\": \"TEN1-CDK3 readthrough (NMD candidate)\",\n    \"symbol\": \"TEN1-CDK3\",\n    \"query\": \"CDK3\"\n  },\n  {\n    \"_id\": \"ENSG00000261408\",\n    \"_score\": 6.9872007,\n    \"ensembl\": {\n      \"gene\": \"ENSG00000261408\",\n      \"protein\": \"ENSP00000490118\",\n      \"transcript\": [\n        \"ENST00000567351\",\n        \"ENST00000569284\"\n      ],\n      \"translation\": [\n        {\n          \"protein\": \"ENSP00000490118\",\n          \"rna\": \"ENST00000569284\"\n        }\n      ]\n    },\n    \"name\": \"TEN1-CDK3 readthrough (NMD candidate)\",\n    \"symbol\": \"TEN1-CDK3\",\n    \"query\": \"CDK3\"\n  }\n]", :trace-redirects []})

(def parsed-response-result '({:_id "1017", :_score 79.10487, :ensembl {:gene "ENSG00000123374", :protein ["ENSP00000243067" "ENSP00000266970" "ENSP00000393605" "ENSP00000450983" "ENSP00000452138" "ENSP00000452514"], :transcript ["ENST00000266970" "ENST00000354056" "ENST00000440311" "ENST00000553376" "ENST00000554545" "ENST00000554619" "ENST00000555357" "ENST00000555408" "ENST00000556146" "ENST00000556276" "ENST00000556464" "ENST00000556656"], :translation [{:protein "ENSP00000266970", :rna "ENST00000266970"} {:protein "ENSP00000450983", :rna "ENST00000555408"} {:protein "ENSP00000452514", :rna "ENST00000553376"} {:protein "ENSP00000393605", :rna "ENST00000440311"} {:protein "ENSP00000452138", :rna "ENST00000555357"} {:protein "ENSP00000243067", :rna "ENST00000354056"}]}, :entrezgene 1017, :name "cyclin dependent kinase 2", :symbol "CDK2", :query "CDK2"} {:_id "143384", :_score 4.4531994, :ensembl {:gene "ENSG00000151893", :protein ["ENSP00000358147" "ENSP00000431329"], :transcript ["ENST00000369151" "ENST00000477583" "ENST00000481360" "ENST00000489169" "ENST00000490610" "ENST00000493518" "ENST00000544392"], :translation [{:protein "ENSP00000358147", :rna "ENST00000369151"} {:protein "ENSP00000431329", :rna "ENST00000493518"}]}, :entrezgene 143384, :name "CDK2 associated cullin domain 1", :symbol "CACUL1", :query "CDK2"} {:_id "1018", :_score 87.98147, :ensembl {:gene "ENSG00000250506", :protein ["ENSP00000400088" "ENSP00000410561" "ENSP00000465062" "ENSP00000466237"], :transcript ["ENST00000425876" "ENST00000448471" "ENST00000586261" "ENST00000588812"], :translation [{:protein "ENSP00000466237", :rna "ENST00000588812"} {:protein "ENSP00000410561", :rna "ENST00000425876"} {:protein "ENSP00000465062", :rna "ENST00000586261"} {:protein "ENSP00000400088", :rna "ENST00000448471"}]}, :entrezgene 1018, :name "cyclin dependent kinase 3", :symbol "CDK3", :query "CDK3"} {:_id "100529145", :_score 6.988237, :entrezgene 100529145, :name "TEN1-CDK3 readthrough (NMD candidate)", :symbol "TEN1-CDK3", :query "CDK3"} {:_id "ENSG00000261408", :_score 6.9872007, :ensembl {:gene "ENSG00000261408", :protein "ENSP00000490118", :transcript ["ENST00000567351" "ENST00000569284"], :translation [{:protein "ENSP00000490118", :rna "ENST00000569284"}]}, :name "TEN1-CDK3 readthrough (NMD candidate)", :symbol "TEN1-CDK3", :query "CDK3"}))


(def subsetted-result-result '({:symbol "CDK2", :name "cyclin dependent kinase 2", :entrezgene 1017, :ensembl "ENSG00000123374"} {:symbol "CACUL1", :name "CDK2 associated cullin domain 1", :entrezgene 143384, :ensembl "ENSG00000151893"} {:symbol "CDK3", :name "cyclin dependent kinase 3", :entrezgene 1018, :ensembl "ENSG00000250506"} {:symbol "TEN1-CDK3", :name "TEN1-CDK3 readthrough (NMD candidate)", :entrezgene 100529145, :ensembl nil} {:symbol "TEN1-CDK3", :name "TEN1-CDK3 readthrough (NMD candidate)", :entrezgene nil, :ensembl "ENSG00000261408"}))

(def example-fields "symbol,name,entrezgene,ensembl")

(facts "about parsed-response"
       (fact "it turns a response-string into a json-dict"
             (parsed-response request-result) => parsed-response-result))


(facts "about subsetted-result"
       (fact "it returns the subset of the fields you want"
             (subsetted-result example-fields parsed-response-result) => subsetted-result-result))
